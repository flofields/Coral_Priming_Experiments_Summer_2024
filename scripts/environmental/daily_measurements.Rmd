---
title: "Daily measurement analysis of 2024 Priming experiment ENCORE"
author: "Florence Fields"
date: "2024-06-12"
output: html_document
---

This script reads and plots environmental data from daily measurements. This script was created by Jill Ashey and altered to suit this data and experiment purposes.  

## Set up 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

Load packages
```{r}
library(tidyverse)
library(stringr)
library(readxl)
library(purrr)
library(lubridate)
library(ggplot2)
library(seacarb)
library(broom)
library(cowplot)
```

Read in daily measurements file.  

```{r}
daily<-read_csv("data/enviromental/daily_measurements.csv")
daily$date<-as.Date(daily$date, format="%m/%d/%y")
daily$tris.date<-as.character(daily$tris.date)

# remove values with NA for temp, salinity and pH
daily <- daily %>%
  drop_na(temp.C)
```

## Calculate total pH  

Calculate the calibration curve from the Tris calibration and calculate pH on the total scale from pH.mV.   
```{r}
pHcalib<-read_csv("data/enviromental/Tris_Calibration.csv")
pHcalib$tris.date<-as.character(pHcalib$tris.date)

pHSlope<-pHcalib %>%
  nest_by(tris.date)%>%
  mutate(fitpH = list(lm(mVTris~Ttris, data = pHcalib))) %>% # linear regression of mV and temp of the tris
  reframe(broom::tidy(fitpH)) %>% # make the output tidy
  dplyr::select(tris.date, term, estimate) %>%
  pivot_wider(names_from = term, values_from = estimate) %>%# put slope and intercept in their own column
  left_join(daily, ., by="tris.date") %>% # join with the pH sample data
  mutate(mVTris = temp.C*Ttris + `(Intercept)`) %>%# calculate the mV of the tris at temperature in which the pH of the tanks were measured
  mutate(pH.total = seacarb::pH(Ex=ph.mV, Etris=mVTris, S=sal.psu, T=temp.C)) # calculate pH of the tanks using the pH seacarb function
```

pH is now calculated as Total pH in the "pH" column. Now select the desired columns to analyze further.  
```{r}
daily_calc<-pHSlope%>%
  dplyr::select(date, time, tank, treatment, temp.C, sal.psu, par, flow.mL5s, ph.nbs, pH.total)
```

## Calculate flow and par

Calculate flow to total mL per minute rather than 5 sec.  
```{r}
daily_calc<-daily_calc%>%
   mutate(flow.L.min=(flow.mL5s*12)/1000)%>%
   dplyr::select(!flow.mL5s)
```

No need to apply the immersion correction factor. The MQ-510 Underwater Quantum Meters already apply the immersion effect correction factor to the meter readings through the meter firmware. [See Documentation Here](https://www.apogeeinstruments.com/underwater-par-measurements/)

## Change to long format

Change data format to long format 
```{r}
daily_calc.long <-daily_calc %>% pivot_longer(cols=temp.C:flow.L.min,
  names_to = "metric",
  values_to = "value")
```

Filter by relevant dates if needed

## Plot metrics of interest  

Plot by date colored by treatment and tank.  (may change script in the fields according to my needs)    
```{r}
## Treatment
daily_treatment<-daily_calc.long %>%
  ggplot(aes(x=date, y=value, colour=treatment))+
  geom_point(size=2)+
  xlab("Date")+
  facet_wrap(metric ~ ., scales = "free")+
  theme_bw(); daily_treatment
  
ggsave(filename="output/environmental/treatment_daily_measurements.png", plot=daily_treatment, dpi=300, width=6, height=8, units="in")

## Tank type
daily_tank<-daily_calc.long %>%
  ggplot(aes(x=date, y=value, colour=tank))+
  geom_point(size=2)+
  xlab("Date")+
  facet_grid(metric ~ ., scales = "free")+
  theme_bw(); daily_tank
  
ggsave(filename="output/environmental/tank_daily_measurements.png", plot=daily_tank, dpi=300, width=6, height=8, units="in")
```

Plot means by tank. (may add acclimation tank so basin 7)     
```{r}
# Plot by basin
basin_daily_treatment_summary<-daily_calc.long %>%
  #filter(is.na(Squarical)) %>%
  filter(Type %in% c("Basin 1", "Basin 2", "Basin 3", "Basin 4", "Basin 5", "Basin 6"))%>%
  
  ggplot(aes(x=tank, y=value, colour=treatment))+
  geom_point()+
  geom_boxplot()+
  scale_colour_manual(name="", values=c("blue", "red"))+
  xlab("Date")+
  ylab("Value")+
  facet_wrap(~ metric, scales = "free")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +  # Rotate text by 45 degrees
  theme_classic(); basin_daily_treatment_summary

ggsave(filename="output/environmental/basin_summary_daily_measurements.png", plot=basin_daily_treatment_summary, dpi=300, width=9, height=6, units="in")

```

## Test for differences   

Use the daily_calc df created earlier.

Test for differences between treatments.
```{r}
daily_calc%>%
  aov(flow.L.min~treatment, data=.)%>%
  summary()
 
daily_calc%>%
  aov(par~treatment, data=.)%>%
  summary()

daily_calc%>%
  aov(pH.total~treatment, data=.)%>%
  summary()

daily_calc%>%
  aov(ph.nbs~treatment, data=.)%>%
  summary()

daily_calc%>%
  aov(sal.psu~treatment, data=.)%>%
  summary()

daily_calc%>%
  aov(temp.C~treatment, data=.)%>%
  summary()
```

Test for differences between tanks and treatment 
```{r}
daily_calc%>%
  aov(flow.L.min~tank*treatment, data=.)
 
daily_calc%>%
  aov(par~tank*treatment, data=.)%>%
  summary()

daily_calc%>%
  aov(pH.total~tank*treatment, data=.)%>%
  summary()

daily_calc%>%
  aov(ph.nbs~tank*treatment, data=.)%>%
  summary()

daily_calc%>%
  aov(sal.psu~tank*treatment, data=.)%>%
  summary()

daily_calc%>%
  aov(temp.C~tank*treatment, data=.)%>%
  summary()
```

## Summarize daily measurements  

Calculate descriptive statistics   
```{r}
summary<-daily_calc%>%
  group_by(tank, treatment)%>%
  select(!date)%>%
  select(!time)%>%
  summarise(across(everything(), list(mean = mean, sd = sd), na.rm = TRUE)); summary

write_csv(summary, "output/environmental/daily_measurements_summary.csv")
```




